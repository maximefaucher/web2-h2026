# Fermeture (*closure*)

## Mise en contexte

Analysons un peu le modèle de départ du TP1. On a organisé la structure de dossiers/fichiers afin d'appliquer l'architecture MVC à l'application :

|Composante|Rôle|Dossiers/fichiers associés|
|---|---|---|
|**Modèle**|Modèles de données du projet|`src/models/*`|
||Dans le cas présent, seulement la classe `Item`||
|**Vue**|Affichage des menus, données & saisies utilisateur|`src/ui/*`|
||On y retrouve des **appels** aux fonctions du contrôleur||
|**Contrôleur**|Logique de contrôle de l'application|`src/services/*`|
||On y retrouve l'**implémentation du code** de la logique||

## Le cas du contrôleur

Dans le fichier `src/services/repo.js`, on remarque quelque chose de particulier :

> **Tout est exporté**... sauf le tableau `_items`!

On peut donc se demander la chose suivante :

> *Si le tableau qui contient les objets de la classe `Item` que l'application gère **n'est pas exporté** (donc **pas importable** de l'extérieur), mais **comment l'application peut-elle modifier ce même tableau**?*  
Étrange n'est-ce pas?

La réponse... la **fermeture** (ou *closure* en anglais)!

## La fermeture

Voir la référence du [MDN ici](https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Closures).

### Définition

Selon cette référence, on définit la fermeture de la façon suivante :

> **DÉFINITION : fermeture**  
Une **fermeture** est la **paire formée d'une fonction et des références à son état environnant** (l'environnement lexical). En d'autres termes, une fermeture donne accès à la portée d'une fonction externe à partir d'une fonction interne (on dit aussi que la fonction « capture son environnement »).

Le tableau `_items` n'est pas exporté directement, mais **toutes les fonctions exportées conservent donc une référence à la portée du module** où elles ont été déclarées, c'est-à-dire `repo.js`.

Ainsi, quand un module externe comme `menu.js` importe une fonction comme `ajouter()` ou `lister()` :

```javascript
import { lister, ajouter, retirerParId, filtrer, trier } from '../services/repo.js';
```

Ces fonctions sont **"fermées" avec** la variable `_items`. Elles peuvent y accéder et la modifier, *même après l'importation*, parce qu'elles ont **mémorisé l'environnement où elles ont été créées**.

### Analogie

C'est comme si vous aviez une boîte fermée (le module `repo.js`) avec un tableau à l'intérieur (`_items`). De l'extérieur, vous ne pouvez pas accéder directement à ce tableau, mais vous avez des « fenêtres » (les fonctions `ajouter`, `lister`, etc.) par lesquelles vous pouvez le voir ou le modifier.

### Avantages

L'utilisation de la fermeture ici permet ainsi un certain pattern d'**encapsulation** très utile :

- ✅ `_items` est protégé (pas d'accès direct)
- ✅ Les modifications passent obligatoirement par les fonctions du module (validations, logique métier)
- ✅ Vous contrôlez totalement comment les données sont manipulées

C'est pourquoi `menu.js` peut utiliser `ajouter()`, `lister()`, `retirerParId()`, etc., mais ne peut pas directement accéder à `_items`!
